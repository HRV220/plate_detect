# Сервис для анонимизации номерных знаков v1.0.0

Продакшен-готовый асинхронный сервис на FastAPI для детекции автомобильных номеров на изображениях и наложения на них кастомной заглушки.

## Основные возможности

- **Асинхронная обработка:** Сервис мгновенно принимает задачи и обрабатывает их в фоновом режиме, не заставляя клиента ждать.
- **Пакетная обработка:** Эффективная обработка множества изображений за один запрос для максимальной производительности.
- **Поддержка форматов:** Принимает изображения в форматах JPEG, PNG и WebP.
- **Высокая производительность:** Использует YOLOv8-OBB для точной детекции и оптимизирован для работы на CPU.
- **Надежность:** Профессиональная архитектура, централизованная конфигурация, полное логирование и обработка ошибок.
- **Готовность к развертыванию:** Упакован в Docker-контейнер для легкого и воспроизводимого деплоя.
- **Автоматическая документация:** Интерактивная документация API доступна через Swagger UI (`/docs`) и ReDoc (`/redoc`).

## Архитектура

Проект имеет четкую слоистую архитектуру для максимальной поддерживаемости:

- **API Layer (`/app/api`)**: Отвечает за прием, валидацию и форматирование HTTP-запросов и ответов. Разделен на бизнес-логику (`v1`) и служебные эндпоинты (`utils`).
- **Service Layer (`/app/services`)**: Реализует бизнес-логику управления задачами (создание, хранение, фоновая обработка).
- **Core Layer (`/app/core`)**: Содержит основную логику обработки изображений (`processor.py`), конфигурацию (`config.py`) и настройки логирования.

## Запуск проекта

### Требования

- [Docker](https://www.docker.com/get-started)

### Инструкция по запуску

1.  **Соберите Docker-образ:**
    (Убедитесь, что вы находитесь в корневой папке `server/`)

    ```bash
    docker build -t plate-cover-service .
    ```

2.  **Запустите контейнер:**

    ```bash
    docker run -d -p 8000:8000 --name plate-cover-container -v "$(pwd)/tasks_storage":/app/tasks_storage plate-cover-service
    ```

    - `-d`: запуск в фоновом режиме.
    - `-p 8000:8000`: проброс порта.
    - `-v`: монтирование локальной папки `tasks_storage` внутрь контейнера для сохранения результатов. Это позволяет получить доступ к файлам с хост-машины.

3.  **Проверка логов:**
    ```bash
    docker logs -f plate-cover-container
    ```

Сервис будет доступен по адресу `http://localhost:8000`.

## Использование API

Полная интерактивная документация доступна по адресу **`http://localhost:8000/docs`**.

### Форматы данных

#### 1. Создание задачи

**Эндпоинт:** `POST /api/v1/process-task/`

**Формат запроса:**

- **Тип:** `multipart/form-data`
- **Параметр:** `files`
- **Описание:** Список из одного или нескольких файлов изображений. Поддерживаемые форматы: `image/jpeg`, `image/png`, `image/webp`.

**Пример запроса (cURL):**

```bash
curl -X POST "http://localhost:8000/api/v1/process-task/" \
     -F "files=@/path/to/your/image1.jpg" \
     -F "files=@/path/to/your/image2.webp"
```

**Формат ответа (Успех, `202 Accepted`):**

- **Тип:** `application/json`
- **Описание:** JSON-объект, содержащий уникальный идентификатор созданной задачи.
- **Пример:**
  ```json
  {
    "task_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef"
  }
  ```

---

#### 2. Проверка статуса задачи

**Эндпоинт:** `GET /api/v1/task-status/{task_id}`

**Формат запроса:**

- **Тип:** Path-параметр
- **Параметр:** `task_id` (строка)
- **Описание:** Уникальный идентификатор, полученный на предыдущем шаге.

**Пример запроса (cURL):**

```bash
curl -X GET "http://localhost:8000/api/v1/task-status/a1b2c3d4-e5f6-7890-1234-567890abcdef"
```

**Формат ответа (Успех, `200 OK`):**

- **Тип:** `application/json`
- **Описание:** JSON-объект с текущим статусом задачи и результатами (если они готовы).
- **Возможные статусы:** `pending`, `processing`, `completed`, `failed`.
- **Пример (задача в процессе):**
  ```json
  {
    "task_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
    "status": "processing",
    "results": []
  }
  ```
- **Пример (задача завершена):**
  ```json
  {
    "task_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
    "status": "completed",
    "results": [
      {
        "filename": "covered_image1.jpg",
        "url": "/tasks_storage/a1b2c3d4.../output/covered_image1.jpg"
      },
      {
        "filename": "covered_image2.jpg",
        "url": "/tasks_storage/a1b2c3d4.../output/covered_image2.jpg"
      }
    ]
  }
  ```

### Служебные эндпоинты

- **`GET /health`**: Эндпоинт для проверки работоспособности сервиса. Возвращает `{"status": "ok"}`.
- **`GET /docs`**: Интерактивная документация Swagger UI.
- **`GET /redoc`**: Альтернативная документация ReDoc.

## Конфигурация через переменные окружения

При запуске Docker-контейнера можно переопределить некоторые настройки:

- `PROCESSING_DEVICE`: Устройство для вычислений (например, `cpu` или `cuda`). По умолчанию: `cpu`.
  - Пример: `docker run -e PROCESSING_DEVICE=cuda ...`
