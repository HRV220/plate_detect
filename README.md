# Сервис для анонимизации номерных знаков v1.0.0

Продакшен-готовый асинхронный сервис на FastAPI для детекции автомобильных номеров на изображениях и наложения на них кастомной заглушки.

## Основные возможности

- **Асинхронная обработка:** Сервис мгновенно принимает задачи и обрабатывает их в фоновом режиме, не заставляя клиента ждать.
- **Пакетная обработка:** Эффективная обработка множества изображений за один запрос для максимальной производительности.
- **Поддержка форматов:** Принимает изображения в форматах JPEG, PNG и WebP.
- **Высокая производительность:** Использует YOLOv8-OBB для точной детекции и оптимизирован для работы на CPU.
- **Надежность:** Профессиональная архитектура, централизованная конфигурация, полное логирование и обработка ошибок.
- **Готовность к развертыванию:** Упакован в Docker-контейнер для легкого и воспроизводимого деплоя.
- **Автоматическая документация:** Интерактивная документация API доступна через Swagger UI (`/docs`) и ReDoc (`/redoc`).

## Установка и запуск

Проект упакован в Docker, что делает его запуск быстрым и воспроизводимым на любой системе.

### Пререквизиты

Перед началом убедитесь, что у вас установлены:

- [Git](https://git-scm.com/downloads)
- [Docker](https://www.docker.com/get-started)

### Пошаговая инструкция

1.  **Клонируйте репозиторий:**
    Откройте терминал и выполните следующую команду, чтобы скачать проект на ваш компьютер.

    ```bash
    git clone https://github.com/your-username/your-repository-name.git
    ```

    _(Не забудьте заменить `your-username/your-repository-name.git` на реальный URL вашего репозитория)_

2.  **Перейдите в директорию сервиса:**
    Весь код, необходимый для запуска, находится в папке `server/`.

    ```bash
    cd your-repository-name/server/
    ```

3.  **Подготовьте необходимые ресурсы:**
    Этот сервис требует наличия обученной модели и изображения-заглушки.

    - Поместите вашу обученную модель (`best.pt`) в папку `server/models/`.
    - Поместите ваше изображение-заглушку (`cover.png`) в папку `server/static/`.

4.  **Соберите Docker-образ:**
    Эта команда прочитает `Dockerfile` и соберет самодостаточный образ вашего приложения со всеми зависимостями.

    ```bash
    docker build -t plate-cover-service .
    ```

5.  **Запустите Docker-контейнер:**
    Эта команда запустит ваш сервис в фоновом режиме.

    ```bash
    docker run -d -p 8000:8000 --name plate-cover-container -v "$(pwd)/tasks_storage":/app/tasks_storage plate-cover-service
    ```

    - `-d`: запуск в фоновом режиме.
    - `-p 8000:8000`: проброс порта 8000 из контейнера на ваш локальный компьютер.
    - `--name`: присвоение удобного имени контейнеру.
    - `-v "$(pwd)/tasks_storage":/app/tasks_storage`: монтирование локальной папки `tasks_storage` внутрь контейнера. Это нужно, чтобы результаты обработки сохранялись на вашем компьютере, а не терялись при удалении контейнера.

6.  **Проверьте, что сервис работает:**
    Вы можете посмотреть логи контейнера, чтобы убедиться, что все запустилось без ошибок.

    ```bash
    docker logs -f plate-cover-container
    ```

    Вы должны увидеть сообщения о запуске Gunicorn и вашего FastAPI приложения.

Теперь ваш сервис доступен по адресу **`http://localhost:8000`**.

### Локальная разработка (без Docker)

Если вы хотите вносить изменения в код, вы можете запустить сервис локально:

1.  Убедитесь, что у вас установлен Python 3.10+.
2.  Создайте и активируйте виртуальное окружение:
    ```bash
    python -m venv venv
    source venv/bin/activate  # Для Windows: venv\Scripts\activate
    ```
3.  Установите зависимости:
    ```bash
    pip install -r requirements.txt
    ```
4.  Запустите сервер для разработки:
    ```bash
    uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
    ```

## Использование API

Полная интерактивная документация доступна по адресу **`http://localhost:8000/docs`**.

### Форматы данных

#### 1. Создание задачи

**Эндпоинт:** `POST /api/v1/process-task/`

**Формат запроса:**

- **Тип:** `multipart/form-data`
- **Параметр:** `files`
- **Описание:** Список из одного или нескольких файлов изображений. Поддерживаемые форматы: `image/jpeg`, `image/png`, `image/webp`.

**Пример запроса (cURL):**

```bash
curl -X POST "http://localhost:8000/api/v1/process-task/" \
     -F "files=@/path/to/your/image1.jpg" \
     -F "files=@/path/to/your/image2.webp"
```

**Формат ответа (Успех, `202 Accepted`):**

- **Тип:** `application/json`
- **Описание:** JSON-объект, содержащий уникальный идентификатор созданной задачи.
- **Пример:**
  ```json
  {
    "task_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef"
  }
  ```

---

#### 2. Проверка статуса задачи

**Эндпоинт:** `GET /api/v1/task-status/{task_id}`

**Формат запроса:**

- **Тип:** Path-параметр
- **Параметр:** `task_id` (строка)
- **Описание:** Уникальный идентификатор, полученный на предыдущем шаге.

**Пример запроса (cURL):**

```bash
curl -X GET "http://localhost:8000/api/v1/task-status/a1b2c3d4-e5f6-7890-1234-567890abcdef"
```

**Формат ответа (Успех, `200 OK`):**

- **Тип:** `application/json`
- **Описание:** JSON-объект с текущим статусом задачи и результатами (если они готовы).
- **Возможные статусы:** `pending`, `processing`, `completed`, `failed`.
- **Пример (задача в процессе):**
  ```json
  {
    "task_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
    "status": "processing",
    "results": []
  }
  ```
- **Пример (задача завершена):**
  ```json
  {
    "task_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
    "status": "completed",
    "results": [
      {
        "filename": "covered_image1.jpg",
        "url": "/tasks_storage/a1b2c3d4.../output/covered_image1.jpg"
      },
      {
        "filename": "covered_image2.jpg",
        "url": "/tasks_storage/a1b2c3d4.../output/covered_image2.jpg"
      }
    ]
  }
  ```

### Служебные эндпоинты

- **`GET /health`**: Эндпоинт для проверки работоспособности сервиса. Возвращает `{"status": "ok"}`.
- **`GET /docs`**: Интерактивная документация Swagger UI.
- **`GET /redoc`**: Альтернативная документация ReDoc.

## Конфигурация через переменные окружения

При запуске Docker-контейнера можно переопределить некоторые настройки:

- `PROCESSING_DEVICE`: Устройство для вычислений (например, `cpu` или `cuda`). По умолчанию: `cpu`.
  - Пример: `docker run -e PROCESSING_DEVICE=cuda ...`
